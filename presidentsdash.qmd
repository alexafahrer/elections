---
title: "Ô∏èUS Presidential Elections"
format: 
  dashboard:
    nav-buttons: [github]
---

```{r}
#| label: load-packages-and-data
#| message: false
#| include: false

library(tidyverse)
library(DT)
library(usmap)
library(shiny)
library(tools)

presidents <- read_csv("data/1976-2020-president.csv", show_col_types = FALSE)
```

#  {.sidebar}

This dashboard displays the various presidential election data,[^1] from 1976 to 2020. 
<hr>

Begin by selecting a year to investigate:
```{r}
#| label: user-input

selectInput(
  inputId = "input_year",
  label = strong("Election Year"),
  choices = unique(presidents$year),
  selected = 1976
)

# https://quarto.org/docs/interactive/
```

<hr>

::: {.callout-note}
## Plot Note

These plots represent the presidential **popular vote** in each state
from the selected year.
:::

<br>

[^1]: MIT Election Data and Science Lab, [MIT Data Lab](https://electionlab.mit.edu/). 
The MIT data were gathered from the [Harvard Dataverse Database](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/42MVDX).

# Home

```{r}
#| label: functions
#| include: false

reformat_name <- function(name) {
  parts <- strsplit(name, ", ")[[1]]
  formatted_name <- paste(trimws(parts[2]), trimws(parts[1]))
  text_lower <- tolower(formatted_name)
  formatted_name <- toTitleCase(text_lower)
  return(formatted_name)
}

lower_case <- function(name) {
  text_lower <- tolower(name)
  formatted_name <- toTitleCase(text_lower)
  return(formatted_name)
}

multiply_by_100 <- function(x) {
  return(paste0(x * 100, " points"))
}
```

```{r}
#| label: data-sets-for-plots
#| include: false

presidents_winner <- presidents |>
  filter(
    year == 1976,
    party_simplified %in% c("DEMOCRAT", "REPUBLICAN")
  ) |>
  group_by(state) |>
  filter(candidatevotes == max(candidatevotes)) |>
  ungroup() |>
  select(year, state, state_fips, candidate, party_simplified, candidatevotes, totalvotes) |>
  group_by(candidate) |>
  summarize(total_votes = sum(candidatevotes)) |>
  mutate(perc = total_votes / sum(total_votes)) |>
  group_by(candidate) |>
  mutate(candidate = reformat_name(candidate)) |>
  ungroup()

gradient_map_data <- presidents |>
  filter(
    party_simplified %in% c("DEMOCRAT", "REPUBLICAN"),
    state != "DISTRICT OF COLUMBIA",
    year == 1976
  ) |>
  select(party_simplified, year, state_fips, candidatevotes, totalvotes) |>
  mutate(perc_votes = candidatevotes / totalvotes) |>
  arrange(party_simplified) |>
  group_by(year, state_fips) |>
  reframe(rep_dem_diff = diff(perc_votes)) |>
  select(-year) |>
  rename(fips = state_fips, values = rep_dem_diff)

red_blue_map_data <- presidents |>
  filter(year == 1976) |>
  group_by(state) |>
  filter(candidatevotes == max(candidatevotes)) |>
  ungroup() |>
  select(state_fips, party_detailed) |>
  rename(fips = state_fips, values = party_detailed)

swing_states <- presidents |>
  filter(
    party_simplified %in% c("DEMOCRAT", "REPUBLICAN"),
    year == 1976
  ) |>
  mutate(swing_state = if_else(state_po %in% c("NM", "NV", "IA", "FL", "VA", "OK", "TN"), TRUE, FALSE)) |>
  select(state_fips, swing_state) |>
  rename(fips = state_fips, values = swing_state)

#1976: 
#1980:
#1984:
#1988: c("NV", "AZ", "WI", "MI", "PA", "NC", "GA")
#1992: c("NV", "AZ", "MT", "OH", "NH", "NJ", "NC", "GA", "FL")
#1996: c("NV", "AZ", "MT", "CO", "KY", "VA", "TN", "GA")
#2000: c("OR", "NM", "MN", "IA", "WI", "NH", "FL")
#2004: c("NV", "NM", "IA", "WI", "OH", "PA", "NH")
#2008: c("MT", "MO", "IN", "NC", "FL")
#2012: c("OH", "NC", "FL")
#2016: c("NV", "MN", "WI", "MI", "PA", "NH", "ME", "FL")
#2020: c("NV", "AZ", "WI", "MI", "PA", "NC", "GA")
# https://usafacts.org/articles/what-are-the-current-swing-states-and-how-have-they-changed-over-time/ 
```


## Row {height="15%"}

```{r}
#| content: valuebox
#| title: "Year"

list(
  color = "secondary",
  value = "1976"
)
```

```{r}
#| content: valuebox
#| title: "Popular Vote Winner"

list(
  color = "#346EF0",
  value = presidents_winner |>
    filter(perc == max(perc)) |>
    pull(candidate)
)
```


```{r}
#| content: valuebox
#| title: "Percentage of Popular Vote Won"

list(
  color = "secondary",
  value = presidents_winner |>
    filter(perc == max(perc)) |>
    mutate(perc = scales::percent(perc, accuracy = 0.1)) |>
    pull(perc)
)
```

```{r}
#| content: valuebox
#| title: "Losing Candidate"

list(
  color = "#EB3323",
  value = presidents_winner |>
    filter(perc == min(perc)) |>
    pull(candidate)
)
```

## Row {height="40%"}

### Column {width="40%", .fill}

```{r}
#| title: Presidential Gradient

plot_usmap("states", data = gradient_map_data) +
  scale_fill_gradient2(
    labels = multiply_by_100, low = "#346EF0",
    high = "#EB3323", mid = "white", midpoint = 0
  ) +
  labs(fill = "Point Differential") +
  theme(
    legend.position = "right",
    legend.title = element_text(vjust = 1, face = "bold", size = 14),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12)
  )
```

### Column {width="40%", .fill}

```{r}
#| title: Presidential Winners

plot_usmap("states", data = red_blue_map_data) +
  scale_fill_manual(values = c("#346EF0", "#EB3323"), labels = lower_case) +
  labs(fill = "Presidential Party") +
  theme(
    legend.position = "right",
    legend.title = element_text(vjust = 1, face = "bold", size = 14),
    legend.key.size = unit(1.2, "cm"),
    legend.text = element_text(size = 12)
  )
```

## Row {height="15%"}

### Column {width="20%"}

```{r}
#| title: "Swing State #1: Iowa"

plot_usmap("states", include = "IA", data = red_blue_map_data, show.legend = FALSE) +
  scale_fill_manual(values = c("DEMOCRAT" = "#346EF0", "REPUBLICAN" = "#EB3323"))
```

### Column {width="20%"}

```{r}
#| title: "Swing State #2: North Carolina"

plot_usmap("states", include = "NC", data = red_blue_map_data, show.legend = FALSE) +
  scale_fill_manual(values = c("DEMOCRAT" = "#346EF0", "REPUBLICAN" = "#EB3323"))
```

### Column {width="20%"}

```{r}
#| title: "Swing State #3: Arizona"

plot_usmap("states", include = "AZ", data = red_blue_map_data, show.legend = FALSE) +
  scale_fill_manual(values = c("DEMOCRAT" = "#346EF0", "REPUBLICAN" = "#EB3323"))
```

### Column {width="20%"}

```{r}
#| title: "Swing State #4: Ohio"

plot_usmap("states", include = "OH", data = red_blue_map_data, show.legend = FALSE) +
  scale_fill_manual(values = c("#346EF0", "#EB3323"))
```

### Column {width="20%"}

```{r}
#| title: "Swing State #5: Florida"

plot_usmap("states", include = "FL", data = red_blue_map_data, show.legend = FALSE) +
  scale_fill_manual(values = c("#346EF0", "#EB3323"))
```

# Swing States


## Row {height="20%"}

### Column {width="20%"}

```{r}
#| content: valuebox
#| title: "Year"

list(
  color = "secondary",
  value = "1976"
)
```

### Column {width="80%"}

```{r}
#| content: valuebox
#| title: "Question"

# NEED TO DO: make text smaller

list(
  color = "secondary",
  value = "What states are swing states in each election year?"
)
```

## Row {height="80%"}

```{r}
#| title: "Swing States"

plot_usmap("states", data = swing_states) +
  scale_fill_manual(values = c("gray", "purple")) +
  labs(fill = "Swing State") +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold")
  )
```

# Data

```{r}
#| label: data-table

presidents_datatable <- presidents |>
  select(year, state, candidate, party_detailed, writein, candidatevotes, totalvotes) |>
  rowwise() |>
  mutate(
    percentage_of_votes = scales::percent(candidatevotes / totalvotes, accuracy = 0.01),
    state = lower_case(state),
    # candidate = reformat_name(candidate),
    party_detailed = lower_case(party_detailed),
    writein = lower_case(writein)
  ) |>
  rename(
    "Year" = "year", "State" = "state", "Candidate Name" = "candidate",
    "Political Party" = "party_detailed", "Write In?" = "writein",
    "Candidate Votes" = "candidatevotes", "Total State Votes" = "totalvotes",
    "Percentage of Total Vote in State" = "percentage_of_votes"
  )

datatable(presidents_datatable)
```

